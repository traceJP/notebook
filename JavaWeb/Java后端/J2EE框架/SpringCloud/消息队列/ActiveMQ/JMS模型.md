# 一、JMS消息模型

## 1、JMS模型

- JMS（Java Message Service）Java消息服务，是JavaEE中的规范之一，消息传递是一种软件组件或应用程序之间的通信方法（编程规范）。消息传递系统是一种点对点设施：消息传递客户端可以向任何其他客户端发送消息，也可以从任何其他客户端接收消息。每个客户端都连接到一个消息代理，该代理提供用于创建、发送、接收和读取消息的工具。
- JMS-API：允许应用程序创建、发送、接收和读取消息。定义了一组通用接口和相关语义，允许用 Java 编程语言编写的程序与其他消息传递实现进行通信。
- API架构：

![clipboard.png](JMS%E6%A8%A1%E5%9E%8B.assets/clip_image002.gif)

## 2、点对点模型

- 在点对点模型的消息传递域中，目的地被称为队列（queue）
- 模型特点：
    - 每个消息只能有一个消费者，即一对一的关系。
    - 消息的生产者和消费者之间没有时间上的相关性，无论消费者在生产者发送消息的时候是否处于运行状态，消费者都可以提取信息。如发短信之后，接收者无论什么时候看都可以。
    - 消息被消费后队列中不会再存储，所以消费者不会消费到已经被消费掉的消息。

![clipboard.png](JMS%E6%A8%A1%E5%9E%8B.assets/clip_image004.gif)

## 3、发布订阅模型

- 再发布订阅消息传递域中，目的地被称为主题（topic）
- 模型特点：
    - 生产者将信息发布到主题之中，每个消息可以有多个消费者，即一对多的关系。
    - 生产者和消费者之间有时间上的相关性，订阅某一个主题的消费者只能消费自它订阅之后发布的消息。如加群后不能看到群以前发的消息。
    - 生产者生产时，主题不会保存消息（主题是无状态的），如无人订阅就去生产消息，那么此消息将无任何作用。
- JMS允许客户端创建持久订阅，在一定程度上放松了时间上的相关性要求，持久订阅允许消费者消费它未处于激活状态时发送的消息，如微信公众号订阅。

![clipboard.png](JMS%E6%A8%A1%E5%9E%8B.assets/clip_image006.gif)

# 二、模型组成

## 1、四大组成元素

- 提供者（provider）：实现JMS接口和规范的消息中间价，即MQ等落地实现的服务。
- 生产者（producer）：消息生产者，创建和发送JMS消息的客户端应用。
- 消费者（consumer）：消息消费者，接收和处理JMS消息的客户端应用。

- 消息（message）：生产者和消费者之间通信的内容。

## 2、消息（message）组成

### （1）消息头

- 可以使用javax.jms.Message、MessageProducer接口方法单独或群体指定。

| 名称             | 描述                                                         |
| ---------------- | ------------------------------------------------------------ |
| JMSDestination   | 消息发送的目的地，主要指Queue和Topic消息类型。               |
| JMSMessageID     | 唯一标识提供者发送的每一条消息。该ID由MQ实现产品产生。 客户机只能在消息发送后才能确定消息的JMSMessageID。 |
| JMSDeliveryMode  | 消息持久模式（队列模型默认为持久性消息） 持久性消息（PERSISTENT）、非持久性消息（NON_PERSISTENT） |
| JMSTimestamp     | 提供者发送消息的时间戳                                       |
| JMSExpiration    | 消息失效的时间 消息过期时间=Destination#send方法中timeToLive形参值+发送时刻的GMT时间值。 如果timeToLive值等于零，则Expriration值被设置为零，表示永不过期。 |
| JMSPriority      | 消息的优先级 级别分为0-9。0-4为普通消息，5-9为加急消息。优先级高就一定先发送。 规范保证加急消息必须先于普通消息到达。默认值为4。 |
| JMSCorrelationID | 通常用来链接响应消息与请求消息，由发送消息的 JMS 程序设置。  |
| JMSReplyTo       | 请求程序用它来指出回复消息应发送的地方，由发送消息的 JMS 程序设置 |
| JMSType          | JMS 程序用它来指出消息的类型。                               |
| JMSRedelivered   | More Actions消息的重发标志 false代表该消息是第一次发生，true代表该消息为重发消息。 |

### （2）消息体

- 封装具体的消息数据，可以通过javax.jms.session接口创建对应的消息。这些消息接口都继承javax.jms.Message接口。必须保证生产者和消费者的消息体格式一致。

| 名称          | 描述                                              |
| ------------- | ------------------------------------------------- |
| TextMessage   | 普通字符串消息，包含一个string                    |
| MapMessage    | 一个Map类型消息，key为string，value为Java基本类型 |
| BytesMessage  | 二进制数组消息，包含一个byte数组                  |
| StreamMessage | Java数据流消息，即Java流操作填充和读取            |
| ObjectMessage | 对象消息，包含一个可序列化Java对象                |

### （3）消息属性

- 消息属性是以属性名属性值形式的kv键值对形式制定的，用于扩展消息头，指定一些消息头没有包含的附加消息。类似自定义请求头功能。
- 可以通过javax.jms,Message接口get/setXXXProperty方法进行设置。
```java
// T表示重载的基本数据类型
void set-T-Property(T name, T value);
T get-T-Property(T name);
```
## 3、消息的可靠性

### （1）持久性（PERSISTENT）（MQ实例的可靠性）

- 持久性消息（PERSISTENT）：该消息应该被传送一次，如果JMS提供者出现故障，该消息不会丢失，会在服务器恢复之后再次传递；

- 非持久性消息（NON_PERSISTENT）：最多会传送一次，如果JMS提供者出现故障，该消息将永远丢失；

- 非持久化主题：当订阅的客户端下线（关闭服务）后再次上线（激活状态），这期间内的消息将全部丢失。

- 持久化主题：通过创建持久化主题，订阅的客户端下线后再次上线时，将会重新接收期间内所有的消息。


### （2）事物（TRANSACTION）（生产者的可靠性）

- 可以使消息操作批量提交和回滚。可以通过创建会话时使用连接对象Connection#createSession方法transacted参数指定开启或关闭（Boolean）。

- 生产者使用MessageProducer对象send消息后需要手动提交。

- 消费者消费消息后也需要手动提交，否则将出现消息已被消费，但JMS服务认为没有被消费（消息重复消费）。（事物拦截住了消费后给服务器的通知）。


### （3）签收（ACKNOWLEDGE）（消费者的可靠性）

- 签收就是客户端消费消息后对服务器的反馈，只针对消费者。即快递送货后是自动签收（送到了就默认你已经收到了）还是手动签收（亲自确认发送反馈我已经收到了）。如果服务器没有接收到对应反馈，则认为你没有消费到消息，消息自然不会被消费。

- 注意：JMS提供者可能会再此发送此消息。但是再此发送不会触发消息重发机制。并且忘记签收会导致很严重的后果，如消息堆积在JMS提供者之中。

- 签收的四种模式：（默认为自动签收）


| 名称                | 描述                                                         |
| ------------------- | ------------------------------------------------------------ |
| AUTO_ACKNOWLEDGE    | 自动签收自动反馈。                                           |
| CLIENT_ACKNOWLEDGE  | 手动签收手动调用消息对象方法反馈。                           |
| DUPS_OK_ACKNOWLEDGE | 允许重复消息延迟自动反馈，降低反馈带来的开销，会出现重复消费问题。 |
| SESSION_TRANSACTED  | 已开启事物选项当开启事物时即使选择其他签收模式也会按照此模式运行。当开启事物后，签收模式将直接失效（事物>签收）。 |

 

 

 