# 一、概念

- 主从复制：
    - 当多个redis集群时（假设此时有三个redis服务），其中可以指定每个redis服务为主机或从机。其中主机可以进行读写操作，而从机会自动复制主机上变化的数据，并且从机只能进行读操作。


# 二、配置和使用

- 在进行多个redis服务的主从配置时，遵守配从不配主的原则，即只需要指定从机将跟随那个主机即可，redis将自动识别主从关系并给对应服务进行状态区分。
- 可以选择使用命令进行配置，或者直接将配置写入redis配置文件中
    - 使用命令配置：当服务中断重启后将遗忘跟随主机地址。
```shell
replicaof <主机ip> <主机端口>
```
- 使用配置文件：服务中断重启后将读取配置文件的跟随主机地址。直接将命令配置加入到副本配置文件中即可

## 1、显示当前服务的主从状态

```shell
info replication
```
- 状态解读：

    - master（主机）slave（从机）

    - connected_slaves:0从机个数


![clipboard.png](%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6.assets/clip_image002.gif)

# 三、主从原则

## 1、从机复制原则

- 从机在指定好主机后自动将主机的全部数据进行一次复制（全量复制），而之后主机的数据发生变化后从机也将保持跟新（增量复制）。

## 2、当主机死亡并重启后

- 主机挂了之后，从机不会自动变成主机，而主机回来之后，从机将继续复制主机数据。

## 3、链式主从关系

- 当主机和其他从机成链式关系时，如A-->B-->C，则其中a是主机，b是a的从机是c的主机，c是b的从机。其中可以有效减轻主机a的写压力。

## 4、变更关系

- 当从机中途变更转向时，如本来跟随a，后又跟随b。此时将清除之前的数据，重新建立拷贝最新的数据。
```shell
slaveof <新ip> <新端口>
```
## 5、从机转正

- 将一台从机转变回主机时，原来同步的数据不会被丢弃。
```shell
slaveof no one
```


# 四、哨兵模式

- 在原本的主从原则之中，主机死亡，从机不会自动转变为主机，而哨兵模式可以定期的检测主机是否存活。如果检测到主机死亡，则将进行一次从机的投票选举，票数最多的从机将自动转变为主机继续工作。
- 哨兵配置：
    - 最少票数：当从机的得票数多余最少票数则上位主机。


1. 在服务启动目录新增文件sentine1.conf文件
2. 在其中写入命令->

```shell
sentine1 monitor <监控的数据库名（自定义）> <ip> <端口> <最少票数>
```
3. 使用redis服务启动哨兵

```shell
redis-sentine1 <sentine1.conf文件路径>
```





